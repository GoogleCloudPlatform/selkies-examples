# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

outputs:
- name: App Launcher
  value: "https://broker.endpoints.{{ env['project'] }}.cloud.goog"

imports:
- path: templates/build-vm-images.jinja
  name: build-vm-images.jinja
- path: templates/cleanup-sub-builds.jinja
  name: cleanup-sub-builds.jinja
- path: templates/code-server-infra.jinja
  name: code-server-infra.jinja
- path: templates/copy-gcr-images.jinja
  name: copy-gcr-images.jinja
- path: templates/deploy-app-launcher.jinja
  name: deploy-app-launcher.jinja
- path: templates/deploy-apps.jinja
  name: deploy-apps.jinja
- path: templates/elevate-ql-cb-permissions.jinja
  name: elevate-ql-cb-permissions.jinja
- path: templates/selkies-services.jinja
  name: selkies-services.jinja
- path: templates/vdi-vm-infra.jinja
  name: vdi-vm-infra.jinja
- path: templates/wait-for-iap.jinja
  name: wait-for-iap.jinja

resources:
###
# Elevate Cloud Build permissions
###
- name: elevate-ql-cb-permissions
  type: elevate-ql-cb-permissions.jinja
  properties:
    region: {{ properties['region'] }}
    zone: {{ properties['zone'] }}
    keyFile: '{{ properties['keyFile'] }}'

###
# Enable project services required for deployment
###
- name: selkies-services
  type: selkies-services.jinja

###
# Cleanup sub-builds across subsequent runs.
###
- name: cleanup-sub-builds
  type: cleanup-sub-builds.jinja
  properties:
    build-tags-filter: "selkies-demo-infra|kube-app-launcher|vdi-vm|code-server|deploy-apps|wait-for-iap"

###
# Deploy the app launcher
###
- name: deploy-app-launcher
  type: deploy-app-launcher.jinja
  properties:
    userName: {{ properties['launcherUser'] | default(properties['userName'] + "@qwiklabs.net", true) }}
    region: {{ properties["region"] }}
    launcher-branch: {{ properties["launcher-branch"] }}
    webrtc-branch: {{ properties["webrtc-branch"] }}
    examples-branch: {{ properties["examples-branch"] }}
    dependsOn:
      - cleanup-sub-builds
      - elevate-ql-cb-permissions

###
# Copy images to project GCR
###
- name: copy-gcr-images
  type: copy-gcr-images.jinja
  properties:
    src-project: {{ properties["src-image-project"] }}
    dest-project: {{ env["project"] }}

###
# Build the vdi-vm example VM images
###
- name: build-vdi-vm-examples
  type: build-vm-images.jinja
  properties:
    examples-branch: {{ properties["examples-branch"] }}
    dependsOn:
      - copy-gcr-images

###
# Build code-server infra
###
- name: code-server-infra
  type: code-server-infra.jinja
  properties:
    launcher-branch: {{ properties["launcher-branch"] }}
    examples-branch: {{ properties["examples-branch"] }}
    dependsOn:
      - deploy-app-launcher

###
# Build vdi-vm infra
###
- name: vdi-vm-infra
  type: vdi-vm-infra.jinja
  properties:
    examples-branch: {{ properties["examples-branch"] }}
    region: {{ properties["region"] }}
    dependsOn:
      - deploy-app-launcher

###
# Deploy the apps
###
- name: deploy-apps
  type: deploy-apps.jinja
  properties:
    region: {{ properties["region"] }}
    launcher-branch: {{ properties["launcher-branch"] }}
    webrtc-branch: {{ properties["webrtc-branch"] }}
    examples-branch: {{ properties["examples-branch"] }}
    dependsOn:
      - deploy-app-launcher
      - copy-gcr-images
      - build-vdi-vm-examples

###
# Wait for IAP GCLB endpoint to finish provisioning
###
- name: wait-for-iap
  type: wait-for-iap.jinja
  properties:
    region: {{ properties["region"] }}
    launcher-branch: {{ properties["launcher-branch"] }}
    dependsOn:
      - deploy-apps
